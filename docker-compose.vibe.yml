version: '3.8'

services:
  # Main development environment
  vibe-dev:
    image: vibe-base:latest
    build:
      context: .
      dockerfile: Dockerfile.vibe
      args:
        USER_UID: 1000
        USER_GID: 1000
    container_name: vibe-dev
    hostname: dev.vm.local
    volumes:
      - .:/workspace
      # Cache directories for faster rebuilds
      - vibe_node_modules:/workspace/node_modules
      - vibe_pip_cache:/home/developer/.cache/pip
      - vibe_npm_cache:/home/developer/.npm
      - vibe_playwright:/home/developer/.cache/ms-playwright
      - vibe_cargo_registry:/root/.cargo/registry
      - vibe_cargo_git:/root/.cargo/git
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NODE_ENV=development
      - PYTHONDONTWRITEBYTECODE=1
    ports:
      # Port range from vm.yaml
      - "3120-3129:3120-3129"
      # Common dev ports
      - "3000:3000"
      - "8000:8000"
      - "5173:5173"
    networks:
      - jules
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash
    healthcheck:
      test: ["CMD", "sh", "-c", "command -v node && command -v python3 && command -v cargo && command -v claude"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Optional: Redis service (for presets that need it)
  redis:
    image: redis:7-alpine
    container_name: vibe-redis
    ports:
      - "6379:6379"
    networks:
      - jules
    volumes:
      - vibe_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Optional: PostgreSQL service (for presets that need it)
  postgres:
    image: postgres:15-alpine
    container_name: vibe-postgres
    environment:
      - POSTGRES_USER=developer
      - POSTGRES_PASSWORD=devpass
      - POSTGRES_DB=devdb
    ports:
      - "5432:5432"
    networks:
      - jules
    volumes:
      - vibe_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U developer"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  jules:
    name: jules
    driver: bridge

volumes:
  vibe_node_modules:
    name: vibe_node_modules
  vibe_pip_cache:
    name: vibe_pip_cache
  vibe_npm_cache:
    name: vibe_npm_cache
  vibe_playwright:
    name: vibe_playwright
  vibe_cargo_registry:
    name: vibe_cargo_registry
  vibe_cargo_git:
    name: vibe_cargo_git
  vibe_redis_data:
    name: vibe_redis_data
  vibe_postgres_data:
    name: vibe_postgres_data
