# This is a Tera template for docker-compose.yml
# It will be rendered by the vm-provider crate.

services:
  {{ config.project.name | default(value="vm-project") }}-dev:
    container_name: {{ config.project.name | default(value="vm-project") }}-dev
    build:
      context: {{ project_dir }}
      dockerfile: Dockerfile
      args:
        PROJECT_UID: {{ project_uid }}
        PROJECT_GID: {{ project_gid }}
        PROJECT_USER: {{ project_user }}
    image: {{ config.project.name | default(value="vm-project") }}:latest
    volumes:
      - {{ project_dir }}:/workspace:rw
      {% if is_macos %}
      # macOS specific volume for audio
      - /tmp/pulseaudio.socket:/tmp/pulseaudio.socket
      {% endif %}
      # Additional volumes for package linking, etc. can be added here dynamically
    {% if config.ports and config.ports | length > 0 -%}
    ports:
      {% for name, port in config.ports %}- "{{ port }}:{{ port }}"
      {% endfor %}
    {%- endif %}
    {% if config.environment and config.environment | length > 0 -%}
    environment:
      {% if is_macos %}
      - PULSE_SERVER=unix:/tmp/pulseaudio.socket
      {% endif %}
      {% for name, value in config.environment %}- {{ name }}={{ value }}
      {% endfor %}
    {%- endif %}
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    command: ["tail", "-f", "/dev/null"]
    tty: true
    stdin_open: true
