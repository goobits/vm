# Test Suite Documentation

This directory contains the reorganized test suite for the VM development environment tool. The tests are organized into logical categories for better maintainability and clarity.

## Directory Structure

```
test/
├── unit/
│   ├── config-validation.test.sh    # Configuration validation unit tests
│   └── preset-detection.test.sh     # Framework detection unit tests
├── integration/
│   ├── migration.test.sh            # VM migration system tests
│   └── preset-system.test.sh        # Preset application integration tests
├── system/
│   └── vm-lifecycle.test.sh         # VM lifecycle and operations tests
├── configs/                         # Test configuration files
└── README.md                        # This documentation
```

## Test Categories

### Unit Tests (`test/unit/`)

**Purpose**: Test individual components and functions in isolation.

- **`config-validation.test.sh`**: Tests configuration validation logic
  - JSON schema validation
  - Configuration file parsing
  - Error handling for malformed configs
  
- **`preset-detection.test.sh`**: Tests framework detection functionality
  - React, Vue, Angular, Next.js detection
  - Python (Django, Flask) detection
  - Node.js, Rust, Go detection
  - Multi-technology project detection
  - Edge cases and error handling

### Integration Tests (`test/integration/`)

**Purpose**: Test how components work together and integrate with external systems.

- **`migration.test.sh`**: Tests the VM migration system
  - JSON to YAML config migration
  - Migration dry-run functionality
  - Backup creation and validation
  - JSON config rejection handling

- **`preset-system.test.sh`**: Tests preset application and system integration
  - Preset application workflows
  - VM tool preset commands (`vm preset list`, `vm preset show`)
  - Flag functionality (`--preset`, `--no-preset`)
  - Preset file validation
  - Project info and resource suggestions

### System Tests (`test/system/`)

**Purpose**: Test complete system functionality and end-to-end workflows.

- **`vm-lifecycle.test.sh`**: Tests full VM lifecycle operations
  - VM creation and destruction
  - VM status monitoring
  - Command execution in VMs
  - VM reload functionality
  - Docker integration testing

## Running All Tests

### Main Test Runner

The main test runner (`./run-tests.sh`) still provides comprehensive testing:

```bash
# Run all test suites
./run-tests.sh

# Run specific test suite
./run-tests.sh --suite framework     # Framework validation tests
./run-tests.sh --suite minimal       # Minimal VM functionality
./run-tests.sh --suite services      # Service integration tests
./run-tests.sh --suite languages     # Language support tests
./run-tests.sh --suite cli           # CLI command tests
./run-tests.sh --suite lifecycle     # Calls system/vm-lifecycle.test.sh
```

### Individual Test Categories

```bash
# Unit tests
./test/unit/config-validation.test.sh
./test/unit/preset-detection.test.sh

# Integration tests  
./test/integration/migration.test.sh
./test/integration/preset-system.test.sh

# System tests
./test/system/vm-lifecycle.test.sh
```

### Specific Test Examples

**Run unit tests**:
```bash
# All unit tests
./test/unit/config-validation.test.sh
./test/unit/preset-detection.test.sh

# Specific framework detection tests
./test/unit/preset-detection.test.sh --detection
./test/unit/preset-detection.test.sh --edge-cases
```

**Run integration tests**:
```bash
# All integration tests
./test/integration/migration.test.sh
./test/integration/preset-system.test.sh

# Specific preset tests
./test/integration/preset-system.test.sh --application
./test/integration/preset-system.test.sh --commands
./test/integration/preset-system.test.sh --flags
```

**Run system tests**:
```bash
# All VM lifecycle tests
./test/system/vm-lifecycle.test.sh

# Individual VM operations
./test/system/vm-lifecycle.test.sh minimal-boot
./test/system/vm-lifecycle.test.sh vm-status
./test/system/vm-lifecycle.test.sh vm-exec
./test/system/vm-lifecycle.test.sh vm-lifecycle
./test/system/vm-lifecycle.test.sh vm-reload
```

## Test Dependencies

### Prerequisites

- **Docker**: Required for VM lifecycle and system tests
  
- **timeout**: Command timeout utility

### Docker Permissions

Many tests require Docker access. If tests are skipped with Docker permission warnings:

```bash
# Add user to docker group
sudo usermod -aG docker $USER

# Restart session
newgrp docker

# Or ensure Docker daemon is running and accessible
sudo systemctl start docker
```

## Configuration Files

Test configuration files are located in `test/configs/`:

- Service-specific configs (postgresql.yaml, redis.yaml, etc.)
- Minimal configuration for basic testing
- Test-specific VM configurations

These are automatically generated by the test framework when needed.

## Migration Guide

### From Old Structure

The previous test structure has been reorganized:

| Old Location | New Location | Notes |
|--------------|--------------|-------|
| `test/test-presets.sh` (detection) | `test/unit/preset-detection.test.sh` | Framework detection only |
| `test/test-presets.sh` (system) | `test/integration/preset-system.test.sh` | Preset application & commands |
| `test.sh` (VM lifecycle) | `test/system/vm-lifecycle.test.sh` | VM operations extracted |
| `test/unit/config-validation.test.sh` | ✓ Already exists | No change |

### Running Reorganized Tests

The main `run-tests.sh` runner has been updated to work with the new structure:

- Framework detection is now separated into unit tests
- VM lifecycle tests are properly categorized as system tests
- Integration tests focus on component interaction
- All existing test functionality is preserved

## Test Development Guidelines

### Adding New Tests

1. **Unit Tests**: Add to `test/unit/` for isolated component testing
2. **Integration Tests**: Add to `test/integration/` for component interaction testing  
3. **System Tests**: Add to `test/system/` for end-to-end workflow testing

### Test Naming Convention

- Use descriptive test function names: `test_framework_detection()`, `test_vm_lifecycle()`
- Use clear assertion messages that explain what should happen
- Group related tests in logical test suites

### Best Practices

- Keep unit tests fast and isolated
- Use appropriate test category for the scope of testing
- Include both positive and negative test cases
- Provide clear error messages and debugging output
- Clean up resources in test teardown

## Troubleshooting

### Common Issues

1. **Docker Permission Denied**: See Docker Permissions section above
2. **Missing Dependencies**: Install required tools (timeout)
3. **Test Timeouts**: Increase timeout values for slower systems
4. **Container Conflicts**: Tests automatically clean up containers but manual cleanup may be needed:
   ```bash
   docker ps -a | grep "test-" | awk '{print $1}' | xargs docker rm -f
   ```

### Debug Mode

Most tests support verbose output:
```bash
VERBOSE=true ./test/unit/preset-detection.test.sh
```

### Getting Help

Each test script includes help documentation:
```bash
./test/unit/preset-detection.test.sh --help
./test/integration/migration.test.sh --help
./test/system/vm-lifecycle.test.sh --help
```