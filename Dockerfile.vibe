# syntax=docker/dockerfile:1.4
# Vibe Development Environment - Multi-stage build with BuildKit cache mounts

# =============================================================================
# STAGE: base
# =============================================================================
FROM ubuntu:22.04 AS base

ARG USER_NAME=developer
ARG USER_UID=1000
ARG USER_GID=1000

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV LANGUAGE=en_US:en

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && apt-get install -y \
    # Init system (prevents zombie processes)
    tini \
    # Locale
    locales \
    # Core tools
    tree ripgrep unzip htop curl wget git git-lfs ca-certificates gnupg \
    # Process/system
    supervisor sudo ufw fail2ban unattended-upgrades \
    # Shell
    zsh zsh-syntax-highlighting \
    # Python base (psycopg2 binary deps only - Python 3.11 installed in final stage)
    libpq-dev \
    # Build tools
    build-essential gcc g++ make pkg-config libssl-dev \
    # Dev utilities
    jq vim nano tmux procps net-tools iputils-ping \
    # Playwright/Chromium deps
    libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libatspi2.0-0 \
    libcups2 libdrm2 libdbus-1-3 libxkbcommon0 libxcomposite1 libxdamage1 \
    libxfixes3 libxrandr2 libgbm1 libasound2 libpango-1.0-0 libcairo2 \
    libxcursor1 libgtk-3-0 libpangocairo-1.0-0 libcairo-gobject2 \
    libgdk-pixbuf-2.0-0 libwayland-client0 libx11-6 libxcb1 libxext6 libglib2.0-0 \
    # WebGL/Vulkan (software rendering)
    libegl1 libgl1-mesa-dri libgles2-mesa libvulkan1 mesa-vulkan-drivers xvfb \
    && locale-gen en_US.UTF-8 \
    && update-locale LANG=en_US.UTF-8

RUN groupadd -g ${USER_GID} ${USER_NAME} || true && \
    useradd -m -u ${USER_UID} -g ${USER_GID} -s /bin/bash ${USER_NAME}

# =============================================================================
# STAGE: node-builder
# =============================================================================
FROM base AS node-builder

ARG USER_NAME=developer
ARG USER_UID=1000
ARG USER_GID=1000
ARG NVM_VERSION=v0.40.3
ARG NODE_VERSION=22

USER ${USER_NAME}
ENV NVM_DIR="/home/${USER_NAME}/.nvm"

RUN mkdir -p $NVM_DIR

RUN --mount=type=cache,target=/home/${USER_NAME}/.nvm/.cache,uid=${USER_UID},gid=${USER_GID} \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/${NVM_VERSION}/install.sh | bash && \
    . $NVM_DIR/nvm.sh && \
    nvm install ${NODE_VERSION} && \
    nvm use ${NODE_VERSION} && \
    nvm alias default ${NODE_VERSION}

RUN --mount=type=cache,target=/home/${USER_NAME}/.npm,uid=${USER_UID},gid=${USER_GID} \
    . $NVM_DIR/nvm.sh && npm install -g \
    @anthropic-ai/claude-code @google/gemini-cli @openai/codex \
    playwright prettier eslint typescript ts-node tsx nodemon npm-check-updates

# Chrome for Testing only available on x86_64
RUN --mount=type=cache,target=/home/${USER_NAME}/.cache/ms-playwright,uid=${USER_UID},gid=${USER_GID} \
    . $NVM_DIR/nvm.sh && \
    npx playwright install chromium firefox && \
    ([ "$(uname -m)" = "x86_64" ] && npx playwright install chrome || true)

# =============================================================================
# STAGE: rust-builder
# =============================================================================
FROM base AS rust-builder

ARG USER_NAME=developer
ARG USER_UID=1000
ARG USER_GID=1000

USER ${USER_NAME}

RUN mkdir -p /home/${USER_NAME}/.cargo /home/${USER_NAME}/.cargo/git /home/${USER_NAME}/.cargo/registry

RUN --mount=type=cache,target=/home/${USER_NAME}/.cargo/registry,uid=${USER_UID},gid=${USER_GID} \
    --mount=type=cache,target=/home/${USER_NAME}/.cargo/git,uid=${USER_UID},gid=${USER_GID} \
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile default && \
    . $HOME/.cargo/env && \
    rustup component add rustfmt clippy rust-analyzer

RUN --mount=type=cache,target=/home/${USER_NAME}/.cargo/registry,uid=${USER_UID},gid=${USER_GID} \
    --mount=type=cache,target=/home/${USER_NAME}/.cargo/git,uid=${USER_UID},gid=${USER_GID} \
    . $HOME/.cargo/env && cargo install cargo-watch cargo-edit cargo-audit cargo-outdated

# =============================================================================
# STAGE: final
# =============================================================================
FROM base AS final

ARG USER_NAME=developer
ARG NODE_VERSION=22

COPY --from=node-builder --chown=${USER_NAME}:${USER_NAME} /home/${USER_NAME}/.nvm /home/${USER_NAME}/.nvm

# Python 3.11 via deadsnakes (don't copy between stages - breaks stdlib)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y python3.11 python3.11-venv python3.11-dev && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11 && \
    pip3 install --no-cache-dir --root-user-action=ignore \
    ansible-core==2.17.6 playwright pytest pytest-playwright psycopg2-binary

COPY --from=rust-builder --chown=${USER_NAME}:${USER_NAME} /home/${USER_NAME}/.cargo /home/${USER_NAME}/.cargo
COPY --from=rust-builder --chown=${USER_NAME}:${USER_NAME} /home/${USER_NAME}/.rustup /home/${USER_NAME}/.rustup

ENV NVM_DIR="/home/${USER_NAME}/.nvm"
ENV PATH="${NVM_DIR}/versions/node/v${NODE_VERSION}/bin:${PATH}"
ENV PATH="/home/${USER_NAME}/.cargo/bin:${PATH}"
ENV CARGO_HOME="/home/${USER_NAME}/.cargo"
ENV RUSTUP_HOME="/home/${USER_NAME}/.rustup"

USER root
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && \
    . /home/${USER_NAME}/.nvm/nvm.sh && \
    npx playwright install-deps chromium firefox && \
    ([ "$(uname -m)" = "x86_64" ] && npx playwright install-deps chrome || true)

WORKDIR /workspace
RUN mkdir -p /workspace && chown -R ${USER_NAME}:${USER_NAME} /workspace

# Shell aliases for AI tools
RUN for rc in /home/${USER_NAME}/.bashrc /home/${USER_NAME}/.zshrc; do \
        echo 'alias yoclaude="claude --dangerously-skip-permissions"' >> "$rc"; \
        echo 'alias yogemini="GEMINI_API_KEY=${GEMINI_API_KEY:-} gemini --yolo"' >> "$rc"; \
        echo 'alias yocodex="codex --dangerously-bypass-approvals-and-sandbox"' >> "$rc"; \
        echo 'export PATH="$PATH:/home/'${USER_NAME}'/.local/bin"' >> "$rc"; \
    done

ENV TZ=America/Los_Angeles
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

ENV NODE_ENV=development \
    PYTHONDONTWRITEBYTECODE=1 \
    PLAYWRIGHT_BROWSERS_PATH=/home/${USER_NAME}/.cache/ms-playwright \
    DISPLAY=:99 \
    LIBGL_ALWAYS_SOFTWARE=1

# Vulkan ICD path (arch-aware)
RUN ARCH=$(uname -m) && \
    echo "export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.${ARCH}.json" >> /etc/profile.d/vulkan-icd.sh && \
    chmod +x /etc/profile.d/vulkan-icd.sh

LABEL org.opencontainers.image.title="Vibe Development Box" \
      org.opencontainers.image.version="1.2" \
      com.vm-tool.preset="vibe" \
      com.vm-tool.snapshot-name="vibe-box"

USER ${USER_NAME}
SHELL ["/bin/bash", "-c"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD bash -c 'source ~/.nvm/nvm.sh && source ~/.cargo/env 2>/dev/null && command -v node && command -v python3 || exit 1'

ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["/bin/bash"]
